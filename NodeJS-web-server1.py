# NodeJS-https-web-server1.py
# Node JS web server in python for testing


import os
import subprocess
import sys

def main():
    
    os.mkdir("web_server")
    os.chdir("web_server")
   
    with open("package.json", "w") as f:
        f.write("""{
  "name": "Da Secret Testing Server Shhhhhhhhh version 0",
  "version": "0.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "start": "node index.js"
  },
  "keywords": [],
  "author": "",
  "license": "ISC"
}
""")
   
    with open("index.js", "w") as f:
        f.write("""const https = require('https');
const fs = require('fs');
const path = require('path');
const express = require('express');
const app = express();
const port = 3000;
const options = {
    key: fs.readFileSync(path.join(__dirname, 'server.key')),
    cert: fs.readFileSync(path.join(__dirname, 'server.cert'))
};
app.get('/', (req, res) => res.send('Testing!'));
https.createServer(options, app).listen(port, () => console.log('Example app listening on port 3000!'));
""")

    
    subprocess.run(["openssl", "req", "-x509", "-nodes", "-days", "365", "-newkey", "rsa:2048", "-keyout", "server.key", "-out", "server.cert", "-subj", "/C=US/ST=California/L=San Francisco/O=Example Company/OU=Example Department/CN=example.com"])
    
    subprocess.run(["sudo", "apt", "install", "nodejs"])
    
    subprocess.run(["sudo", "apt", "install", "npm"])
    
    subprocess.run(["npm", "install", "express"])
    
    subprocess.run(["npm", "install", "https"])
   
    subprocess.run(["npm", "install", "fs"])
    
    subprocess.run(["npm", "install", "path"])
    
    subprocess.run(["npm", "start"])
   
    subprocess.run(["xdg-open", "https://localhost:3000"])
    
    subprocess.run(["ctrl", "+", "c"])
   
    os.chdir("..")
    subprocess.run(["rm", "-rf", "web_server"])
    return 0


if __name__ == "__main__":
    main()
    sys.exit(0)